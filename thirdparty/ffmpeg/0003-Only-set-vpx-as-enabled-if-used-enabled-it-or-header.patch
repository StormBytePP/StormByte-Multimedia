From ac46591a124832cf01d99eeffe98eae96221ad72 Mon Sep 17 00:00:00 2001
From: "David C. Manuelda" <StormByte@gmail.com>
Date: Sat, 27 Dec 2025 01:56:51 +0100
Subject: [PATCH 3/3] Only set vpx as enabled if used enabled it or headers ere
 found

---
 meson.build | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/meson.build b/meson.build
index cae7d9d844..b56b46c8bc 100644
--- a/meson.build
+++ b/meson.build
@@ -3220,7 +3220,19 @@ all_components = avcodec_components_list + avdevice_components_list + avfilter_c
 # If any libvpx subcomponent check passed or the option was explicitly enabled,
 # make sure `libvpx` is present for the depresolver step.
 if not conf.has('libvpx')
-  conf.set10('libvpx', (conf.get('libvpx_vp8_decoder', 0) == 1 or conf.get('libvpx_vp8_encoder', 0) == 1 or conf.get('libvpx_vp9_decoder', 0) == 1 or conf.get('libvpx_vp9_encoder', 0) == 1 or get_option('libvpx').enabled()).to_int())
+  # Honor explicit user disable: if user passed -Dlibvpx=disabled,
+  # ensure libvpx remains disabled and do not probe headers.
+  if get_option('libvpx').disabled()
+    conf.set10('libvpx', 0)
+  else
+    # Only treat libvpx as present if at least one subcomponent was detected
+    # and a vpx header is actually available, or the user explicitly enabled it.
+    has_vpx_header = false
+    if cc.has_header('vpx/vpx_encoder.h') or cc.has_header('vpx/vpx_decoder.h')
+      has_vpx_header = true
+    endif
+    conf.set10('libvpx', ((conf.get('libvpx_vp8_decoder', 0) == 1 or conf.get('libvpx_vp8_encoder', 0) == 1 or conf.get('libvpx_vp9_decoder', 0) == 1 or conf.get('libvpx_vp9_encoder', 0) == 1) and has_vpx_header or get_option('libvpx').enabled()).to_int())
+  endif
 endif
 
 tmpconfig_h = configure_file(configuration: conf, output: 'tmpconfig.h')
-- 
2.52.0

